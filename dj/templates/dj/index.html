{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>PKT DJ</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="shortcut icon" href="{% static 'dj/favicons/favicon.ico' %}">
    <link rel="icon" sizes="16x16 32x32 64x64" href="{% static 'dj/favicons/favicon.ico' %}">
    <link rel="icon" type="image/png" sizes="196x196" href="{% static 'dj/favicons/favicon-192.png' %}">
    <link rel="icon" type="image/png" sizes="160x160" href="{% static 'dj/favicons/favicon-160.png' %}">
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'dj/favicons/favicon-96.png' %}">
    <link rel="icon" type="image/png" sizes="64x64" href="{% static 'dj/favicons/favicon-64.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'dj/favicons/favicon-32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'dj/favicons/favicon-16.png' %}">
    <link rel="apple-touch-icon" href="{% static 'dj/favicons/favicon-57.png' %}">
    <link rel="apple-touch-icon" sizes="114x114" href="{% static 'dj/favicons/favicon-114.png' %}">
    <link rel="apple-touch-icon" sizes="72x72" href="{% static 'dj/favicons/favicon-72.png' %}">
    <link rel="apple-touch-icon" sizes="144x144" href="{% static 'dj/favicons/favicon-144.png' %}">
    <link rel="apple-touch-icon" sizes="60x60" href="{% static 'dj/favicons/favicon-60.png' %}">
    <link rel="apple-touch-icon" sizes="120x120" href="{% static 'dj/favicons/favicon-120.png' %}">
    <link rel="apple-touch-icon" sizes="76x76" href="{% static 'dj/favicons/favicon-76.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'dj/favicons/favicon-152.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'dj/favicons/favicon-180.png' %}">
    <meta name="msapplication-TileColor" content="#FFFFFF">
    <meta name="msapplication-TileImage" content="{% static 'dj/favicons/favicon-144.png' %}">
    <meta name="msapplication-config" content="{% static 'dj/favicons/browserconfig.xml' %}">



    <style type="text/css">
        
        body {
            background: black;
            color: white;
            text-align: center;
        }

        #current_song {
            font-size: 24px;
        }
        #next_song {
            font-size: 24px;
        }

        #current-artist {
            color: green;
        }
        #next-artist {
            color: green;
        }

        #current_info {
            width: 300px;
        }

        .panel {
            background: black;
            border-width: 1px;
            border-color: gray;
            border-radius: 0px 0px 5px 5px;
        }

        div {
            margin: 0 auto;
        }

        #timer {
            color: #3c3;
        }

        #search-bar {
            background: black;
            position: relative;
            width: 200px;
            margin-bottom: 20px;
            margin-top: 20px;
        }
        #search-bar input {
            text-indent: 30px;
            color: black;
            -webkit-border-radius: 50px;
            -moz-border-radius: 50px;
            border-radius: 50px;
            border-color: white;
            font-size: 15px;          

        }
        #search-bar img { 
          position: absolute;
          top: 8px;
          left: 23px;
          opacity: 0.5;
          filter: alpha(opacity=50); /* For IE8 and earlier */
        }

        .carousel-item img {
            opacity: 0.5;
            filter: alpha(opacity=50); /* For IE8 and earlier */
        }

        .slide_btn {
            background-color: Transparent;
            outline:none;
            color: white;
            border-radius: 5px;
            cursor:pointer;
            font-size: 20px;
            border-color: white;
            border-style: solid;

        }

        .slide-place {
            color: #e7d7f7;
        }

        .search-obj {
            border-width: 1px;
            border-bottom-style: solid;
            border-color: #aaa;
            width:300px;
            text-align: left;
            margin-top: 4px;
            margin-bottom: 4px;
            padding: 4px;
        }

        .search-obj .name {
            font-size: 14px;
        }

        .search-obj .artist {
            font-size: 12px;
            color: #aaa;
        }

        .search-obj button {
            float: right;
            font-size: 14px;
        }

        a {
            color: #3a3;"
        }


    </style>


</head>
<body>

    <div id="off_info" style="display: none;">
        <h1>This app isn't currently running.</h1>
        <p>Please try again later!</p>
    </div>

    <div id="whole_div">

        <div class="">
                

                <div id="current_info">
                    <h1>Currently Playing</h1>
                    <img id="current_img" src="" width="300px" height="300px">
                    <div class="panel panel-default" >
                        <p id="current_song"></p>
                        <p id="current_artist" style="color: #aaa;"></p>
                    </div>
                </div>
        </div>
        <div id="time_div" style="display:none;">
            <h2>Time to Vote:</h2>
            <h2 id=timer>3:42</h2>
        </div>
        <div id="next_div" style="display:none;" style="width: 300px;">
            <h2>Next Song:</h2>
            <img id="next_img" src="" width="300px" height="300px">
            <div class="panel panel-default" >
                <p id="next_song"></p>
                <p id="next_artist" style="color: #aaa;"></p>
             </div>
        </div>


 <div class="vote_div">
<div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel" style="width: 300px; display:none;">
  <ol class="carousel-indicators" id="indicators">
  </ol>
  <div class="carousel-inner" id="inner">
  </div>
  <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="sr-only">Next</span>
  </a>
</div>
</div>


<!--         <p>Vote:
            <ol id="voting">
            </ol>
        </p> -->
        

        <div id="search-bar">
            <img src="{% static 'dj/open-iconic/svg/magnifying-glass.svg' %}" width="12px" height="12px" alt="Search"/>
            <input type="text" id="search" name="search"></input>
        </div>

        <div id="results">
          
        </div>
    </div>


    <footer class="page-footer">
    <div class="row" style="width:300px; margin: auto;">
        <div class="col-sm">
          &copy; Piotti 2018
        </div>
        <div class="col-sm">
          <a  href="http://pkt.mit.edu" target="_blank">&Phi;&Kappa;&Theta;</a>
        </div>
    </div>
    <div class="row" style="width:300px; margin: auto;">
        <div class="col-sm">
            <a href="feedback">Leave feedback!</a> 
        </div>
    </div>
    </footer>

</body>

<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>

<script type="text/javascript">

    $.fn.scrollView = function () {
        return this.each(function () {
            $('html, body').animate({
                scrollTop: $(this).offset().top
            }, 500);
        });
    }

    if (!String.prototype.format) {
      String.prototype.format = function() {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function(match, number) { 
          return typeof args[number] != 'undefined'
            ? args[number]
            : match
          ;
        });
      };
    }


    function vote(song_id) {
        $.get('vote/'+song_id, function(data) {
           console.log(data);
           getInfo();
        });
    }

    var num_slides = 0;

    var places = ['1<sup>st</sup>', '2<sup>nd</sup>', '3<sup>rd</sup>', '4<sup>th</sup>', '5<sup>th</sup>'];

    var last_vote = 0;
    var last_place = 0;

    function addSlide(name, artists, img, votes, song_id) {
        var slide_num = num_slides;
        if(slide_num==0) {
            //display carousel
            $('#carouselExampleIndicators').show();
        }
        var active = slide_num == 0 ? 'active' : '';
        var plural = votes == 1 ? '' : 's';

        if (votes < last_vote) {
            last_place += 1;
        }
        last_vote = votes;

        // format params: 0 slide_num, 1 active, 2 song_id, 3 img, 4 name, 5 artists, 6 votes, 7 plural, 8 place
        var inner_txt = '<div id="slide-{0}" class="carousel-item {1}" style="width:300px;"> <span hidden>{2}</span><img class="d-block w-100" src="{3}" alt="slide"> <div class="carousel-caption d-md-block"><h1 class="slide-place">{8}</h1><h5 class="slide-name">{4}</h5> <p class="slide-artist">{5}</p> <p class="slide-vote"> {6} Vote{7}</p><button class="slide_btn btn">Vote</button></div> </div>'.format(
            slide_num, active, song_id, img, name, artists, votes, plural, places[last_place]);
        $('#inner').append(inner_txt);

        var ind_txt = '<li data-target="#carouselExampleIndicators" data-slide-to="{0}" class="{1}" li>'.format(slide_num, active);
        $('#indicators').append(ind_txt);

        num_slides++;

        $('.slide_btn').click(function() {
            var id = $(this).parent().parent().find('span').html();
            console.log('ID: ' + id);
            vote(id);
        });
        
    }


    function setSlide(index, name, artists, img, votes, song_id) {
        if (index >= num_slides) {
            // add new slide
            addSlide(name, artists, img, votes, song_id);
            return;
        }

        if (votes < last_vote) {
            last_place += 1;
        }
        last_vote = votes;

        //update slide params
        var $ele = $('#slide-'+index);
        $ele.find('img').attr('src', img);
        $ele.find('.slide-name').html(name);
        $ele.find('.slide-artist').html(artists);
        var plural = votes == 1 ? '' : 's';
        $ele.find('.slide-vote').html(votes + ' Vote' + plural);
        $ele.find('span').html(song_id);
        $ele.find('.slide-place').html(places[last_place]);


    }

    

    var time_left = 0;
    var queued = false
    function updateTimeLeft(time) {
        time_left = time;
        // $('#next').html('Time left to vote: ');
        var seconds = Math.max(time % 60, 0);
        var minutes = Math.max((time-seconds) / 60, 0);
        // if (minutes > 0) {
            // pad seconds
        var zero = seconds < 10 ? '0': '';
        $('#timer').html(minutes + ':' + zero + seconds);
        // } else
            // $('#queued').html(seconds + ' seconds');


    }

    function getInfo() {
        $.get('info/', function(data) {
            console.log(data);
                
            if (!data['on']) {
                $('#off_info').show();
                $('#whole_div').hide();
                return;
            } else {
                $('#off_info').hide();
                $('#whole_div').show();
            }
           // $('#current').html(data['current']=='Not currently playing music' ? 'Not currently playing music' : data['current']['name'] + '  -  ' + data['current']['artists']);
           if (data['current'] != 'Not currently playing music') {
            console.log('hi');
               $('#current_song').html(data['current']['name']);
               $('#current_artist').html(data['current']['artists']);
               $('#current_img').attr('src', data['current']['artwork']);
           }
            queued = data['queued'] != 'None';
            if (queued) {
                $('#time_div').hide();
                $('#next_div').show();
                $('#next_song').html(data['queued']['name']);
                $('#next_artist').html(data['queued']['artists']);
                $('#next_img').attr('src', data['queued']['artwork']);
            } else{
                $('#time_div').show();
                $('#next_div').hide();
                var time = Math.max(0, Math.round((data['current']['duration'] - data['current']['time']) / 1000) - 30);
                //this condition prevents timer spasming
                if(Math.abs(time - time_left) > 3)
                    updateTimeLeft(time);
            }
            // $('#queued').html(queued ? data['queued']['name'] + '  -  ' + data['queued']['artists'] : 'None');
            // $('#voting').html('');
            last_vote = 0;
            last_place = 0;
            for (var i = 0; i < data['voting'].length; i++) {
                var votes = data['voting'][i]['votes'];
                var name = data['voting'][i]['name'];
                var img = data['voting'][i]['artwork'];
                var artists = data['voting'][i]['artists'];
                var song_id = data['voting'][i]['song_id'];
                setSlide(i, name, artists, img, votes, song_id);
                // var txt = data['voting'][i]['name'] + '  -  ' + data['voting'][i]['artists'];
                // txt += '<br> Votes: ' + data['voting'][i]['votes']
                // // var remove = '  <button class="remove-btn" id="remove-'+data['voting'][i]['id']+'">Remove</button>';
                // $('#voting').append('<li>'+txt+'</li>');
            }

            if (data['voting'].length < num_slides || data['voting'].length == 0) {
                // clear all
                $('#indicators').html('');
                $('#inner').html('');
                num_slides = 0;
                $('#carouselExampleIndicators').hide();
            }

            

             $('.remove-btn').click(function() {
                var id = $(this).attr('id').split('-')[1];
                console.log(id);
                $.get('remove/'+id, function(data) {
                    console.log(data);
                   getInfo();
                })
            });
        });
    }

    function onSearch() {
        console.log($('#search').val());

        $.get('search/?q=' + $('#search').val(), function(data) {
            console.log(data);
            var songs = data['songs'];
            // $('#results').html('<tr><th>Name</th><th>Artists</th><th>Album</th><th>Length</th></tr>');
            $('#results').html('');
            for (var i = 0; i < songs.length; i++) {

                var html = '<div class="search-obj"><button class="btn btn-success" id="result-{0}">Vote</button><div class="name">{1}</div><div class="artist">{2}</div></div>'.format(songs[i]['id'], songs[i]['name'], songs[i]['artists'])
                $('#results').append(html);
            }

            //scroll to results
            $('#results').scrollView();

            $('.search-obj button').click(function() {
                var id = $(this).attr('id').split('-')[1];
                console.log(id);
                vote(id);
            });
        })
    }
    
    $(document).ready(function() {

        getInfo();

        setInterval(function(){
            //refresh
            console.log('updating');
            getInfo();
        }, 2000);

        $('#search-btn').click(function() {
            onSearch();
        });
        $('#search').keypress(function(event) {
            if ( event.which == 13 ) {
                 onSearch();
              }
        });

        setInterval(function(){
            if (time_left > 1);
            updateTimeLeft(time_left - 1);

        }, 1000)

       // setSlide(0, 'name', 'artists', 'http://waybeyond.in/wp-content/uploads/2017/11/linkedin-thumbnail.png', 2, 'fdsfd');


        
    });


</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

</html>